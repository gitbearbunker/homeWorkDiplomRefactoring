# homeWorkDiplomRefactoring - дипломная работа «Облачное хранилище»

## Описание проекта

Разработан REST-сервис. Сервис предоставляет REST-интерфейс для загрузки файлов и вывода списка уже загруженных файлов пользователя. 

Все запросы к сервису должны авторизованы. Подготовленное веб-приложение (FRONT) подключается к разработанному сервису без доработок, используя функционал FRONT для авторизации, загрузки и вывода списка файлов пользователя.

## Описание соответствия заданных требований к приложению

- Сервис предоставляет REST-интерфейс для интеграции с FRONT.
- Сервис реализует все методы:
  1. Вывод списка файлов.
  2. Добавление файла.
  3. Удаление файла.
  4. Авторизация.
- Все настройки вычитываются из файла настроек (ProjectSpecification.yml).
- Информация о пользователях сервиса (логины для авторизации) и данные хранятся в базе данных MySQL.

## Описание соответствия заданных требований к реализации

- Приложение разработано с использованием Spring Boot.
- Использован сборщик пакетов maven.
- Для запуска используется docker, docker-compose.
- Код размещён на Github.
- Код покрыт unit-тестами с использованием mockito.
- Добавлены интеграционные тесты с использованием testcontainers.
___________

## Инструкция по сборке и запуску проекта

1. Установите nodejs (версия не ниже 19.7.0) на компьютер, следуя [инструкции](https://nodejs.org/en/download).
2. Скачайте [FRONT](./netology-diplom-frontend) (JavaScript) или ().
3. Перейдите в папку FRONT приложения и все команды для запуска выполняйте из неё.
4. Следуя описанию README.md FRONT проекта, запустите nodejs-приложение (`npm install`, `npm run serve`).
5. Далее нужно задать url для вызова своего backend-сервиса.
    1. В файле `.env` FRONT (находится в корне проекта) приложения можно изменить url до backend, например: `VUE_APP_BASE_URL=http://localhost:8080`. 
       1. можно указать корневой url вашего backend, к нему frontend будет добавлять все пути согласно спецификации
       2. для `VUE_APP_BASE_URL=http://localhost:8080` при выполнении логина frontend вызовет `http://localhost:8080/login`
    2. Запустите FRONT снова: `npm run serve`.
    3. Изменённый `url` сохранится для следующих запусков.
6. По умолчанию FRONT запускается на порту 8080 и доступен по url в браузере `http://localhost:8080`. 
   1. Если порт 8080 занят, FRONT займёт следующий доступный (`8081`). После выполнения `npm run serve` в терминале вы увидите, на каком порту он запустился. 

### Авторизация приложения

FRONT-приложение использует header `auth-token`, в котором отправляет токен (ключ-строка) для идентификации пользователя на BACKEND.
Для получения токена нужно пройти авторизацию на BACKEND и отправить на метод /login логин и пароль. В случае успешной проверки в ответ BACKEND должен вернуть json-объект
с полем `auth-token` и значением токена. Все дальейшие запросы с FRONTEND, кроме метода /login, отправляются с этим header.
Для выхода из приложения нужно вызвать метод BACKEND /logout, который удалит/деактивирует токен. Последующие запросы с этим токеном будут не авторизованы и вернут код 401.

Обратите внимание, что название самого параметра (как и всех параметров в спецификации), его регистр имеют значение. 
Важно, чтобы ваш backend возвращал токен в поле `auth-token` – если поле будет называться `authToken` или `authtoken`, фронт не сможет найти токен и дальше логина процесс не пройдёт.

### Запуск приложения с помощью файла docker-compose.yml (Dockerfile) 
- Клонируем проект на свой ПК папку с git: cloud_storage-frontend;
- Запускаем приложение Docker Desktop;
- Открываем проект в среде разработки IntelliJ IDEA;
- Собрать jar файл можно двумя способами:
  - Запускаем терминал в корне проекта и собираем jar архив с нашим Spring REST приложением с помощью команд:
```mvn clean package -Dskiptests``` и ```mvn clean package -Dmaven.test.skip```;
  - Во вкладке Maven активируем иконку `Togger 'Skip Tests' Mode`, в катлоге `Lifecycle` активировать команды `clear` и `package`;
- После успешной сборки в папке будет находиться jar файл:`homeWorkDiplom.jar`;
- В терминале выполнить команду по сборке images и containers: ```docker-compose up```;
- В докере запустятся 3 приложения:
  - backend-server, Java 11 на порту: ```http://localhost:8888```;
  - frontend-client, Node 15 на порту: ```http://localhost:8080```;
  - database-server на порту: ```http://localhost:3306```;
- Запустить тесты можно:
  - Через терминал командой `mvn test`;
  - Во вкладке Maven отключаем иконку `Togger 'Skip Tests' Mode`, в катлоге `Lifecycle` активировать команды `test`.
 
### Для тестирования frontend + backend + mysql нужно авторизовать пользователя:
 - Отправить POST запрос `http://localhost:8888/login`
 - JSON -> `{
"login": "User",
"password": "user1234"
}` 

### Если в Базе Данных mysql нет этого пользователя, то нужно создать пользователя 
- Отправить POST запрос `http://localhost:8888/user/register`
- JSON -> `{
  "login": "User",
  "password": "user1234"
  }`  

### Завершение работы
- Выход из приложения: в терминале нажать "Ctrl+C"
- Удаление Docker контейнера: ```docker-compose down```


## База данных

В приложении используется СУБД MySQL, со следующими настройками:

`spring.datasource.url=jdbc:mysql://localhost:3306/mysqlDataBase?createDatabaseIfNotExist=true`

`spring.datasource.username=root`

`spring.datasource.password=root`

В программе используется 3 таблицы БД:

* user_entity - для хранения пользователей. Поля id, login, password, role.
* file_entity - для хранения файлов. Поля id, file_name, file_type, file_data, hash, size, user_id
* user_entity_roles - для сопостановления пользователя и ролей. Поля id, roles, user_entity_id.
